name: sepex-container

on:
  # Run only on branches with PRs (including drafts) into main
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
      - closed

permissions:
  contents: read
  packages: write

jobs:
  release-build:
    name: Build and Push multi-arch release images
    runs-on: ubuntu-latest

    # Only run for PRs where the source branch matches release/**
    if: startsWith(github.head_ref, 'release/')

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}/api

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          # Use merge commit when merged, otherwise PR head sha
          ref: ${{ github.event.pull_request.merge_commit_sha || github.event.pull_request.head.sha }}

      # Enable emulation for building non-native architectures (arm64, etc.)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Extract CalVer (with optional prerelease) from branch name and enforce current year+month.
      #
      # Branch examples:
      #   release/2025.11.0
      #   release/2025.11.0-beta
      #
      # Matches:
      #   YEAR = 2025
      #   MONTH = 11
      #   PATCH = 0
      #   PRERELEASE = -beta 
      - name: Compute and validate CalVer from branch name
        id: version
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_HEAD_REF}"
          echo "Branch: $BRANCH"

          # Regex: YYYY.MM.PATCH with optional -prerelease suffix
          if [[ "$BRANCH" =~ ([0-9]{4})\.([0-9]{1,2})\.([0-9]+)(-[0-9A-Za-z._-]+)? ]]; then
            YEAR="${BASH_REMATCH[1]}"
            MONTH="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PRERELEASE="${BASH_REMATCH[4]}"
          else
            echo "ERROR: No CalVer (YYYY.MM.PATCH[-prerelease]) found in branch name: $BRANCH" >&2
            exit 1
          fi

          MONTH_PADDED=$(printf "%02d" "$MONTH")

          CURRENT_YEAR=$(date +%Y)
          CURRENT_MONTH=$(date +%m)

          echo "Detected CalVer: ${YEAR}.${MONTH_PADDED}.${PATCH}${PRERELEASE}"
          echo "Current year/month: ${CURRENT_YEAR}.${CURRENT_MONTH}"

          if [[ "$YEAR" != "$CURRENT_YEAR" || "$MONTH_PADDED" != "$CURRENT_MONTH" ]]; then
            echo "ERROR: CalVer year/month (${YEAR}.${MONTH_PADDED}) does not match current (${CURRENT_YEAR}.${CURRENT_MONTH})." >&2
            exit 1
          fi

          BASE_VERSION="${YEAR}.${MONTH_PADDED}.${PATCH}"
          if [[ -n "${PRERELEASE}" ]]; then
            FULL_VERSION="${BASE_VERSION}${PRERELEASE}"
          else
            FULL_VERSION="${BASE_VERSION}"
          fi

          echo "Using release_version=${FULL_VERSION}"
          echo "release_version=${FULL_VERSION}" >> "$GITHUB_OUTPUT"

      # ── PR open/draft/sync/ready_for_review: dev-<full-calver> ──
      # Examples:
      #   dev-2025.11.0
      #   dev-2025.11.0-beta
      - name: Extract metadata for dev image (dev-<CalVer>)
        if: github.event.action != 'closed'
        id: meta_dev
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=dev-${{ steps.version.outputs.release_version }}

      - name: Build and push multi-arch dev image (dev-<CalVer>)
        if: github.event.action != 'closed'
        uses: docker/build-push-action@v5
        with:
          context: ./api
          target: prod
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta_dev.outputs.tags }}
          labels: ${{ steps.meta_dev.outputs.labels }}

      # ── PR merged: <full-calver>, no latest ──
      # Examples:
      #   2025.11.0
      #   2025.11.0-beta
      - name: Extract metadata for final release
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        id: meta_release
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.release_version }}

      - name: Build and push final release image
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: docker/build-push-action@v5
        with:
          context: ./api
          target: prod
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta_release.outputs.tags }}
          labels: ${{ steps.meta_release.outputs.labels }}
